rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- GLOBAL HELPERS ---
    
    // Check if the user is the primary owner of this specific data silo (The Admin)
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Check if the user is the designated Super Admin (System Manager)
    function isSuperAdmin() {
      return request.auth != null && 
             request.auth.token.email != null && 
             request.auth.token.email.lower() == 'emeraj@gmail.com';
    }
    
    // Check if the current user is an authorized staff member (Operator) for a specific Shop Owner
    function isStaff(userId) {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(userId)/subUsers/$(request.auth.uid));
    }

    // --- 1. USER REGISTRY (userMappings) ---
    // Critical for resolving multi-user logic and Super Admin dashboard
    match /userMappings/{mappingId} {
      // Super Admin needs to perform collection-wide queries (list) and individual updates (get/write)
      allow read, write: if isSuperAdmin();

      // Standard users can read their own routing record to identify their ownerId and role
      allow read: if request.auth != null && (
        request.auth.uid == mappingId || 
        (resource != null && resource.data.ownerId == request.auth.uid)
      );

      // Users create their own mapping on first signup
      // Admins can manage mapping records of staff they create/delete
      allow write: if request.auth != null && (
        request.auth.uid == mappingId || 
        (request.resource != null && request.resource.data.ownerId == request.auth.uid) ||
        (resource != null && resource.data.ownerId == request.auth.uid)
      );
    }

    // --- 2. SHOP DATA SILOS (users/{userId}) ---
    // All business data is partitioned by the Admin's UID (userId).
    match /users/{userId} {
      
      // Allow general read of the root shop folder for designated parties
      allow read: if isOwner(userId) || isStaff(userId) || isSuperAdmin();

      // Staff (Operator) Management
      // Only the Shop Owner or Super Admin can manage the subUsers list
      match /subUsers/{subUserId} {
        allow read: if isOwner(userId) || (request.auth != null && request.auth.uid == subUserId) || isSuperAdmin();
        allow write: if isOwner(userId) || isSuperAdmin();
      }
      
      // Configuration & Profile (Shop Name, Printing Settings, Subscription status, etc.)
      // Staff can read settings for operational flow, but only Owner/SuperAdmin can edit settings or subscription info
      match /companyProfile/{document=**} {
        allow read: if isOwner(userId) || isStaff(userId) || isSuperAdmin();
        allow write: if isOwner(userId) || isSuperAdmin();
      }
      match /systemConfig/{document=**} {
        allow read: if isOwner(userId) || isStaff(userId) || isSuperAdmin();
        allow write: if isOwner(userId) || isSuperAdmin();
      }
      match /gstRates/{document=**} {
        allow read: if isOwner(userId) || isStaff(userId) || isSuperAdmin();
        allow write: if isOwner(userId) || isSuperAdmin();
      }

      // Operational Collections (Daily Business Activities)
      // products, bills, purchases, suppliers, payments, customers, salesmen, customerPayments, companies
      // Both Owners and their authorized Staff have full CRUD permissions for business operations.
      match /{collectionName}/{document=**} {
        allow read, write: if isOwner(userId) || isStaff(userId) || isSuperAdmin();
      }
    }
  }
}